# 电信CRM客户中心 - 跨服务时序图

## 一、概述

时序图（Sequence Diagram）展示系统各组件之间的交互顺序和消息传递。本文档重点描述跨服务、跨中心的复杂业务场景。

## 二、完整开户流程时序图

### 2.1 个人用户开户全流程

这是电信CRM最核心的业务场景，涉及多个系统的协同。

```
┌────────┐ ┌──────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ 营业员  │ │ API  │ │客户服务 │ │用户服务 │ │账户服务 │ │订单中心 │ │开通中心 │
│        │ │网关  │ │        │ │        │ │        │ │        │ │        │
└───┬────┘ └──┬───┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │         │          │          │          │          │
    │ 1. POST /api/customers/register                                 │
    ├─────────►│         │          │          │          │          │
    │          │         │          │          │          │          │
    │          │ 2. 路由到客户服务                                     │
    │          ├────────►│          │          │          │          │
    │          │         │          │          │          │          │
    │          │         │ 3. 实名认证                                │
    │          │         ├──────┐   │          │          │          │
    │          │         │      │   │          │          │          │
    │          │         │◄─────┘   │          │          │          │
    │          │         │          │          │          │          │
    │          │         │ 4. 检查一证五户                            │
    │          │         ├──────┐   │          │          │          │
    │          │         │      │   │          │          │          │
    │          │         │◄─────┘   │          │          │          │
    │          │         │          │          │          │          │
    │          │         │ 5. 创建客户                                │
    │          │         ├──────┐   │          │          │          │
    │          │         │      │   │          │          │          │
    │          │         │◄─────┘   │          │          │          │
    │          │         │          │          │          │          │
    │          │         │ 6. 发布 CustomerCreatedEvent               │
    │          │         ├──────────────────────────────────────────►│
    │          │         │          │          │          │          │
    │          │◄────────┤          │          │          │          │
    │◄─────────┤         │          │          │          │          │
    │ 200 OK   │         │          │          │          │          │
    │ customerId         │          │          │          │          │
    │          │         │          │          │          │          │
    │ 7. POST /api/users/register                                     │
    ├─────────►│         │          │          │          │          │
    │          │         │          │          │          │          │
    │          │ 8. 路由到用户服务                                     │
    │          ├─────────┼─────────►│          │          │          │
    │          │         │          │          │          │          │
    │          │         │          │ 9. 验证客户存在                 │
    │          │         │          ├─────────►│          │          │
    │          │         │          │          │          │          │
    │          │         │          │◄─────────┤          │          │
    │          │         │          │  客户存在 │          │          │
    │          │         │          │          │          │          │
    │          │         │          │ 10. 检查号码可用性              │
    │          │         │          ├──────┐   │          │          │
    │          │         │          │      │   │          │          │
    │          │         │          │◄─────┘   │          │          │
    │          │         │          │          │          │          │
    │          │         │          │ 11. 创建用户（预开状态）         │
    │          │         │          ├──────┐   │          │          │
    │          │         │          │      │   │          │          │
    │          │         │          │◄─────┘   │          │          │
    │          │         │          │          │          │          │
    │          │         │          │ 12. 调用开通中心                │
    │          │         │          ├─────────────────────────────►│
    │          │         │          │   POST /api/provisioning/user │
    │          │         │          │          │          │          │
    │          │         │          │          │          │          │ 13. 开通网络资源
    │          │         │          │          │          │          ├──────┐
    │          │         │          │          │          │          │ HLR  │
    │          │         │          │          │          │          │      │
    │          │         │          │          │          │          │◄─────┘
    │          │         │          │          │          │          │
    │          │         │          │◄─────────────────────────────┤
    │          │         │          │   200 OK                      │
    │          │         │          │          │          │          │
    │          │         │          │ 14. 发布 UserOpenedEvent       │
    │          │         │          ├──────────────────────────────►│
    │          │         │          │          │          │          │
    │          │◄────────┼──────────┤          │          │          │
    │◄─────────┤         │          │          │          │          │
    │ 200 OK   │         │          │          │          │          │
    │ userId   │         │          │          │          │          │
    │          │         │          │          │          │          │
    │ 15. POST /api/accounts/create                                  │
    ├─────────►│         │          │          │          │          │
    │          │         │          │          │          │          │
    │          │ 16. 路由到账户服务                                   │
    │          ├─────────┼──────────┼─────────►│          │          │
    │          │         │          │          │          │          │
    │          │         │          │          │ 17. 创建账户        │
    │          │         │          │          ├──────┐   │          │
    │          │         │          │          │      │   │          │
    │          │         │          │          │◄─────┘   │          │
    │          │         │          │          │          │          │
    │          │         │          │          │ 18. 发布事件        │
    │          │         │          │          ├──────────────────►│
    │          │         │          │          │          │          │
    │          │◄────────┼──────────┼──────────┤          │          │
    │◄─────────┤         │          │          │          │          │
    │ 200 OK   │         │          │          │          │          │
    │ accountId│         │          │          │          │          │
    │          │         │          │          │          │          │
    │ 19. POST /api/accounts/bind-user                               │
    ├─────────►│         │          │          │          │          │
    │          │         │          │          │          │          │
    │          │ 20. 路由到账户服务                                   │
    │          ├─────────┼──────────┼─────────►│          │          │
    │          │         │          │          │          │          │
    │          │         │          │          │ 21. 绑定用户        │
    │          │         │          │          ├──────┐   │          │
    │          │         │          │          │      │   │          │
    │          │         │          │          │◄─────┘   │          │
    │          │         │          │          │          │          │
    │          │◄────────┼──────────┼──────────┤          │          │
    │◄─────────┤         │          │          │          │          │
    │ 200 OK   │         │          │          │          │          │
    │          │         │          │          │          │          │
    │ 22. POST /api/accounts/recharge                                │
    ├─────────►│         │          │          │          │          │
    │          │         │          │          │          │          │
    │          │ 23. 路由到账户服务                                   │
    │          ├─────────┼──────────┼─────────►│          │          │
    │          │         │          │          │          │          │
    │          │         │          │          │ 24. 调用支付平台     │
    │          │         │          │          ├──────┐   │          │
    │          │         │          │          │ 支付  │   │          │
    │          │         │          │          │      │   │          │
    │          │         │          │          │◄─────┘   │          │
    │          │         │          │          │          │          │
    │          │         │          │          │ 25. 增加余额        │
    │          │         │          │          ├──────┐   │          │
    │          │         │          │          │      │   │          │
    │          │         │          │          │◄─────┘   │          │
    │          │         │          │          │          │          │
    │          │         │          │          │ 26. 发布充值事件     │
    │          │         │          │          ├──────────────────►│
    │          │         │          │          │          │          │
    │          │◄────────┼──────────┼──────────┤          │          │
    │◄─────────┤         │          │          │          │          │
    │ 200 OK   │         │          │          │          │          │
    │          │         │          │          │          │          │
    │ [客户首次激活手机]                                               │
    │          │         │          │          │          │          │
    │          │         │          │ 27. 检测到激活信号              │
    │          │         │          ├──────┐   │          │          │
    │          │         │          │      │   │          │          │
    │          │         │          │◄─────┘   │          │          │
    │          │         │          │          │          │          │
    │          │         │          │ 28. 更新为正常状态              │
    │          │         │          ├──────┐   │          │          │
    │          │         │          │      │   │          │          │
    │          │         │          │◄─────┘   │          │          │
    │          │         │          │          │          │          │
    │          │         │          │ 29. 发布 UserActivatedEvent    │
    │          │         │          ├──────────────────────────────►│
    │          │         │          │          │          │          │
    │          │         │          │          │          │          │
```

### 2.2 关键交互说明

**同步调用：**
1. **客户验证**（步骤9）：用户服务同步调用客户服务验证客户存在
2. **网络开通**（步骤12-13）：用户服务同步调用开通中心，等待开通完成
3. **支付处理**（步骤24）：账户服务同步调用支付平台

**异步事件：**
1. **CustomerCreatedEvent**（步骤6）：客户创建后发布事件
2. **UserOpenedEvent**（步骤14）：用户开户后发布事件
3. **AccountOpenedEvent**（步骤18）：账户创建后发布事件
4. **AccountRechargedEvent**（步骤26）：充值后发布事件
5. **UserActivatedEvent**（步骤29）：用户激活后发布事件

**事务边界：**
- 每个服务内部操作是一个本地事务
- 跨服务通过最终一致性保证数据一致性
- 使用Saga模式处理分布式事务

## 三、套餐变更流程时序图

### 3.1 套餐变更（立即生效）

```
┌────────┐ ┌──────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│  客户   │ │ API  │ │用户服务 │ │订购服务 │ │产商品   │ │计费中心 │
│        │ │网关  │ │        │ │        │ │中心    │ │        │
└───┬────┘ └──┬───┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │         │          │          │          │
    │ 1. POST /api/users/{userId}/change-package              │
    ├─────────►│         │          │          │          │
    │  packageId: "PKG-100"                                   │
    │  effectiveType: "IMMEDIATE"                             │
    │          │         │          │          │          │
    │          │ 2. 路由到用户服务                            │
    │          ├────────►│          │          │          │
    │          │         │          │          │          │
    │          │         │ 3. 查询用户信息                   │
    │          │         ├──────┐   │          │          │
    │          │         │      │   │          │          │
    │          │         │◄─────┘   │          │          │
    │          │         │          │          │          │
    │          │         │ 4. 查询新套餐信息                 │
    │          │         ├─────────────────────►│          │
    │          │         │  GET /api/products/{packageId}    │
    │          │         │          │          │          │
    │          │         │◄─────────────────────┤          │
    │          │         │  套餐详情             │          │
    │          │         │          │          │          │
    │          │         │ 5. 检查套餐变更规则               │
    │          │         ├──────┐   │          │          │
    │          │         │互斥? │   │          │          │
    │          │         │依赖? │   │          │          │
    │          │         │◄─────┘   │          │          │
    │          │         │          │          │          │
    │          │         │ 6. 计算套餐差价                   │
    │          │         ├─────────────────────────────────►│
    │          │         │  POST /api/billing/calculate-diff │
    │          │         │          │          │          │
    │          │         │◄─────────────────────────────────┤
    │          │         │  补差费: 30元                     │
    │          │         │          │          │          │
    │          │         │ 7. 扣除补差费                     │
    │          │         ├─────────────────────────────────►│
    │          │         │  POST /api/billing/deduct        │
    │          │         │          │          │          │
    │          │         │◄─────────────────────────────────┤
    │          │         │  扣费成功                         │
    │          │         │          │          │          │
    │          │         │ 8. 更新套餐信息                   │
    │          │         ├──────┐   │          │          │
    │          │         │      │   │          │          │
    │          │         │◄─────┘   │          │          │
    │          │         │          │          │          │
    │          │         │ 9. 创建订购记录                   │
    │          │         ├─────────►│          │          │
    │          │         │          │          │          │
    │          │         │◄─────────┤          │          │
    │          │         │          │          │          │
    │          │         │ 10. 发布 PackageChangedEvent     │
    │          │         ├──────────►│          │          │
    │          │         │          ├──────────────────────►│
    │          │         │          │  事件: 套餐已变更      │
    │          │         │          │          │          │
    │          │◄────────┤          │          │          │
    │◄─────────┤         │          │          │          │
    │ 200 OK   │         │          │          │          │
    │          │         │          │          │          │
```

### 3.2 关键交互说明

**业务规则检查：**
1. **套餐互斥检查**（步骤5）：检查是否与当前订购的其他产品互斥
2. **套餐依赖检查**（步骤5）：检查必须的依赖产品是否已订购

**计费处理：**
1. **计算差价**（步骤6）：立即生效需要计算当月补差费
2. **扣除补差费**（步骤7）：从账户扣除补差费

**事件发布：**
- **PackageChangedEvent**：套餐变更事件，通知计费中心更新计费规则

## 四、欠费停复机时序图

### 4.1 欠费自动停机流程

```
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│计费中心 │ │账户服务 │ │用户服务 │ │消息服务 │ │开通中心 │
│        │ │        │ │        │ │        │ │        │
└───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │          │          │          │
    │ 1. 每日批量计费                              │
    ├──────┐   │          │          │          │
    │      │   │          │          │          │
    │◄─────┘   │          │          │          │
    │          │          │          │          │
    │ 2. 批量扣费请求                              │
    ├─────────►│          │          │          │
    │  POST /api/accounts/batch-deduct            │
    │          │          │          │          │
    │          │ 3. 逐个处理扣费                   │
    │          ├──────┐   │          │          │
    │          │      │   │          │          │
    │          │◄─────┘   │          │          │
    │          │          │          │          │
    │          │ 4. 余额不足！                     │
    │          ├──────┐   │          │          │
    │          │      │   │          │          │
    │          │◄─────┘   │          │          │
    │          │          │          │          │
    │          │ 5. 发布 AccountBalanceInsufficientEvent
    │          ├──────────►│          │          │
    │          │          │          │          │
    │          │          │ 6. 订阅到事件         │
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │          │          │
    │          │          │ 7. 记录欠费           │
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │          │          │
    │          │          │ 8. 发送欠费提醒       │
    │          │          ├─────────►│          │
    │          │          │          │          │
    │          │          │          │ 9. 发短信 │
    │          │          │          ├──────┐   │
    │          │          │          │      │   │
    │          │          │          │◄─────┘   │
    │          │          │          │          │
    │          │          │ [等待7天]             │
    │          │          │          │          │
    │          │          │ 10. 定时任务检查欠费  │
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │  欠费超7天！          │
    │          │          │          │          │
    │          │          │ 11. 用户停机          │
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │  状态: SUSPENDED_ARREARS
    │          │          │          │          │
    │          │          │ 12. 发布 UserStatusChangedEvent
    │          │          ├─────────►│          │
    │          │          │          │          │
    │          │          │ 13. 调用开通中心停机  │
    │          │          ├──────────────────────►│
    │          │          │  POST /api/provisioning/suspend │
    │          │          │          │          │
    │          │          │          │          │ 14. 停机操作
    │          │          │          │          ├──────┐
    │          │          │          │          │ HLR  │
    │          │          │          │          │      │
    │          │          │          │          │◄─────┘
    │          │          │          │          │
    │          │          │◄──────────────────────┤
    │          │          │  200 OK               │
    │          │          │          │          │
    │          │          │ 15. 发送停机通知      │
    │          │          ├─────────►│          │
    │          │          │          │          │
    │          │          │          │ 16. 发短信│
    │          │          │          ├──────┐   │
    │          │          │          │      │   │
    │          │          │          │◄─────┘   │
    │          │          │          │          │
```

### 4.2 充值自动复机流程

```
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│  客户   │ │账户服务 │ │用户服务 │ │消息服务 │ │开通中心 │
│        │ │        │ │        │ │        │ │        │
└───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │          │          │          │
    │ 1. 充值100元                                │
    ├─────────►│          │          │          │
    │          │          │          │          │
    │          │ 2. 调用支付平台                  │
    │          ├──────┐   │          │          │
    │          │      │   │          │          │
    │          │◄─────┘   │          │          │
    │          │          │          │          │
    │          │ 3. 增加余额                      │
    │          ├──────┐   │          │          │
    │          │      │   │          │          │
    │          │◄─────┘   │          │          │
    │          │          │          │          │
    │          │ 4. 发布 AccountRechargedEvent   │
    │          ├──────────►│          │          │
    │          │          │          │          │
    │          │          │ 5. 订阅到事件         │
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │          │          │
    │          │          │ 6. 检查是否有欠费停机用户
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │  找到停机用户！        │
    │          │          │          │          │
    │          │          │ 7. 检查欠费是否结清   │
    │          │          ├─────────►│          │
    │          │          │          │          │
    │          │          │◄─────────┤          │
    │          │          │  欠费已结清           │
    │          │          │          │          │
    │          │          │ 8. 用户复机           │
    │          │          ├──────┐   │          │
    │          │          │      │   │          │
    │          │          │◄─────┘   │          │
    │          │          │  状态: ACTIVE         │
    │          │          │          │          │
    │          │          │ 9. 发布 UserStatusChangedEvent
    │          │          ├─────────►│          │
    │          │          │          │          │
    │          │          │ 10. 调用开通中心复机  │
    │          │          ├──────────────────────►│
    │          │          │  POST /api/provisioning/resume │
    │          │          │          │          │
    │          │          │          │          │ 11. 复机操作
    │          │          │          │          ├──────┐
    │          │          │          │          │ HLR  │
    │          │          │          │          │      │
    │          │          │          │          │◄─────┘
    │          │          │          │          │
    │          │          │◄──────────────────────┤
    │          │          │  200 OK               │
    │          │          │          │          │
    │          │          │ 12. 发送复机通知      │
    │          │          ├─────────►│          │
    │          │          │          │          │
    │          │          │          │ 13. 发短信│
    │          │          │          ├──────┐   │
    │          │          │          │      │   │
    │          │          │          │◄─────┘   │
    │          │          │          │          │
    │◄─────────┤          │          │          │
    │  充值成功 │          │          │          │
    │          │          │          │          │
```

## 五、跨中心业务编排时序图

### 5.1 开户业务完整编排（Saga模式）

```
┌──────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ 订单中心  │ │客户中心 │ │产商品   │ │开通中心 │ │计费中心 │
│  (编排器) │ │        │ │中心    │ │        │ │        │
└─────┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
      │          │          │          │          │
      │ 1. 接收开户订单                              │
      ├──────┐   │          │          │          │
      │      │   │          │          │          │
      │◄─────┘   │          │          │          │
      │          │          │          │          │
      │ 2. 创建客户                                  │
      ├─────────►│          │          │          │
      │  POST /api/customers                        │
      │          │          │          │          │
      │◄─────────┤          │          │          │
      │  customerId         │          │          │
      │          │          │          │          │
      │ 3. 查询产品信息                              │
      ├─────────────────────►│          │          │
      │          │          │          │          │
      │◄─────────────────────┤          │          │
      │  产品详情             │          │          │
      │          │          │          │          │
      │ 4. 创建用户                                  │
      ├─────────►│          │          │          │
      │  POST /api/users                            │
      │          │          │          │          │
      │          │ 4.1 调用开通中心                  │
      │          ├─────────────────────►│          │
      │          │          │          │          │
      │          │◄─────────────────────┤          │
      │          │          │          │          │
      │◄─────────┤          │          │          │
      │  userId  │          │          │          │
      │          │          │          │          │
      │ 5. 创建账户                                  │
      ├─────────►│          │          │          │
      │  POST /api/accounts                         │
      │          │          │          │          │
      │◄─────────┤          │          │          │
      │  accountId          │          │          │
      │          │          │          │          │
      │ 6. 绑定用户到账户                            │
      ├─────────►│          │          │          │
      │          │          │          │          │
      │◄─────────┤          │          │          │
      │  OK      │          │          │          │
      │          │          │          │          │
      │ 7. 通知计费中心                              │
      ├─────────────────────────────────────────────►│
      │  POST /api/billing/notify-new-user          │
      │          │          │          │          │
      │◄─────────────────────────────────────────────┤
      │  OK      │          │          │          │
      │          │          │          │          │
      │ 8. 更新订单状态                              │
      ├──────┐   │          │          │          │
      │      │   │          │          │          │
      │◄─────┘   │          │          │          │
      │  订单完成 │          │          │          │
      │          │          │          │          │
```

### 5.2 异常补偿流程

如果步骤4（创建用户）失败，需要补偿：

```
┌──────────┐ ┌────────┐
│ 订单中心  │ │客户中心 │
│  (编排器) │ │        │
└─────┬────┘ └───┬────┘
      │          │
      │ 创建用户失败！
      ├──────┐   │
      │      │   │
      │◄─────┘   │
      │          │
      │ 补偿: 删除客户
      ├─────────►│
      │  DELETE /api/customers/{customerId}
      │          │
      │◄─────────┤
      │  OK      │
      │          │
      │ 更新订单状态为失败
      ├──────┐   │
      │      │   │
      │◄─────┘   │
      │          │
```

## 六、设计要点总结

### 6.1 同步vs异步选择

**使用同步调用的场景：**
1. **强一致性要求**：如开通中心的网络开通，必须等待完成
2. **需要立即响应**：如实名认证、支付处理
3. **关键业务验证**：如客户存在性验证、号码可用性检查

**使用异步事件的场景：**
1. **跨服务通知**：如用户状态变更通知计费中心
2. **最终一致性**：如账户余额变更通知用户服务
3. **解耦系统**：通过事件总线降低服务间耦合

### 6.2 超时和重试策略

1. **同步调用超时**：设置合理的超时时间（如3秒）
2. **重试策略**：使用指数退避算法，最多重试3次
3. **熔断机制**：连续失败后自动熔断，快速失败

### 6.3 分布式事务处理

1. **Saga模式**：将长事务拆分为多个本地事务，每个事务有补偿操作
2. **事件溯源**：通过事件记录所有状态变更，支持审计和回滚
3. **最终一致性**：接受短暂的数据不一致，通过事件最终达到一致

### 6.4 服务编排

1. **中心化编排**：订单中心作为编排器，协调多个服务
2. **去中心化协同**：通过事件驱动，服务自主协作
3. **混合模式**：核心流程使用编排，非核心流程使用协同

## 七、总结

本文档详细描述了客户中心核心业务的跨服务时序图，重点包括：

1. **完整开户流程**：涉及5个服务，29个步骤的复杂协同
2. **套餐变更流程**：展示业务规则检查和计费处理
3. **欠费停复机流程**：展示事件驱动的自动化处理
4. **业务编排流程**：展示Saga模式的分布式事务处理

这些时序图是系统集成和接口设计的重要参考，确保服务间交互的正确性和完整性。
