# 电信CRM客户中心 - 架构设计

## 一、总体架构

### 1.1 架构概览

```
┌────────────────────────────────────────────────────────────────┐
│                          客户端层                               │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                  │
│  │ Web  │ │ APP  │ │ USSD │ │ Call │ │ POS  │                  │
│  │      │ │      │ │      │ │Center│ │      │                  │
│  └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘                  │
└─────┼────────┼────────┼────────┼────────┼──────────────────────┘
      │        │        │        │        │
      └────────┴────────┴────────┴────────┘
               │
┌──────────────▼──────────────────────────────────────────────────┐
│                        API网关层                                 │
│  ┌────────────────────────────────────────────────────────┐     │
│  │           API Gateway (Spring Cloud Gateway)           │     │
│  │  - 统一入口       - 认证授权     - 限流熔断    - 协议转换 │     │
│  └────────────────────────────────────────────────────────┘     │
└──────────┬───────────────┬─────────────┬──────────────┬─────────┘
           │               │             │              │
┌──────────▼───────────────▼─────────────▼──────────────▼─────────┐
│                        微服务层                                  │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌─────────────┐   │
│  │  Customer │  │   User    │  │  Account  │  │Subscription │   │
│  │  Service  │  │  Service  │  │  Service  │  │  Service    │   │
│  │  (8081)   │  │  (8082)   │  │  (8083)   │  │  (8084)     │   │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └──────┬──────┘   │
│        │              │              │               │          │
│        └──────────────┴──────────────┴───────────────┘          │
│                       │  Events                                 │
│  ┌────────────────────▼────────────────────────────────────┐     │
│  │             Message Queue (Kafka)                       │    │
│  └─────────────────────────────────────────────────────────┘    │
└──────────┬───────────────┬─────────────┬──────────────┬─────────┘
           │               │             │              │
┌──────────▼───────────────▼─────────────▼──────────────▼─────────┐
│                        数据层                                    │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌─────────────┐   │
│  │customer_db│  │  user_db  │  │account_db │  │subscription │   │
│  │  (MySQL)  │  │  (MySQL)  │  │  (MySQL)  │  │    _db      │   │
│  │  + Redis  │  │ + Redis   │  │ + Redis   │  │  (MySQL)    │   │
│  └───────────┘  └───────────┘  └───────────┘  └─────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      基础设施层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ Config   │  │ Registry │  │ Message  │  │  Monitor │         │
│  │ Service  │  │ Service  │  │ Service  │  │ Service  │         │
│  │  (配置)  │  │  (注册)   │  │  (消息)  │  │  (监控)  │         │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
└─────────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────┐
│                      外部系统                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │  订单    │  │ 产商品    │  │  开通    │  │  计费    │          │
│  │  中心    │  │  中心     │  │  中心    │  │  中心    │          │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 架构特点

1. **分层架构**：客户端层、API网关层、微服务层、数据层、基础设施层
2. **微服务架构**：按业务能力拆分为独立的微服务
3. **事件驱动**：通过消息队列实现服务间异步通信
4. **数据库分离**：每个微服务独立数据库
5. **高可用**：服务多实例部署、数据库主从复制
6. **可扩展**：支持水平扩展、分库分表

## 二、高并发适配方案

### 2.1 需求分析

**业务量：**
- 每日业务办理量：300W
- 每日服务调用：4亿次
- 高峰时段：早8-10点、下午2-4点
- 高峰期流量：平峰期的3倍

**计算：**
- 平均TPS：4亿 / (24 * 3600) ≈ 4630 TPS
- 高峰TPS：4630 * 3 ≈ 14000 TPS

### 2.2 缓存策略

#### 2.2.1 多级缓存架构

```
┌────────────┐
│   请求     │
└──────┬─────┘
       │
┌──────▼──────┐  Miss  ┌───────────┐  Miss  ┌──────────┐
│ Local Cache │───────►│   Redis   │───────►│ Database │
│  (Caffeine) │        │  Cluster  │        │  (MySQL) │
└─────────────┘        └───────────┘        └──────────┘
       │                     │                    │
       │ Hit                 │ Hit                │
       ▼                     ▼                    ▼
    返回数据              返回数据            返回数据
```

**本地缓存（Caffeine）：**
- 用途：缓存热点数据
- 容量：1000条
- 过期时间：5分钟
- 适用数据：客户信息、用户信息、套餐信息

**Redis集群：**
- 架构：3主3从
- 用途：分布式缓存、分布式锁、限流计数器
- 过期策略：LRU
- 适用数据：用户会话、接口限流、分布式锁

#### 2.2.2 缓存更新策略

**Cache Aside模式：**
1. 读取数据：先查缓存，缓存miss则查数据库，然后写入缓存
2. 更新数据：先更新数据库，然后删除缓存

**缓存预热：**
- 系统启动时加载热点数据
- 定时任务刷新缓存

**缓存穿透防护：**
- 布隆过滤器过滤无效请求
- 空值缓存（过期时间短）

**缓存雪崩防护：**
- 缓存过期时间随机化
- 热点数据永不过期
- 熔断降级

**缓存击穿防护：**
- 热点数据永不过期
- 分布式锁（Redis）

### 2.3 数据库优化

#### 2.3.1 读写分离

```
┌─────────────┐
│  Application│
└──────┬──────┘
       │
┌──────▼──────┐
│   Routing   │
│   (ShardingSphere)
└──┬────────┬─┘
   │ Write  │ Read
   │        │
┌──▼───┐  ┌──▼───────────┐
│Master│  │  Slave 1     │
│(写)  │  │  (读)        │
└──┬───┘  └──────────────┘
   │        ┌─────────────┐
   │        │  Slave 2    │
   └───────►│  (读)       │
 Replication└─────────────┘
```

**主库（Master）：**
- 处理所有写操作
- 实时性要求高的读操作

**从库（Slave）：**
- 处理查询操作
- 统计分析操作
- 报表生成

**读写分离规则：**
- `@Transactional`注解的方法路由到主库
- 查询方法路由到从库
- 强一致性查询路由到主库

#### 2.3.2 分库分表

**用户表分表：**
```
user_db
├── user_000  (user_id % 256 = 0)
├── user_001  (user_id % 256 = 1)
├── ...
└── user_255  (user_id % 256 = 255)
```

**分片键：** user_id

**分片算法：** user_id % 256

**路由规则：**
```yaml
sharding:
  tables:
    user:
      actualDataNodes: user_db.user_${0..255}
      tableStrategy:
        standard:
          shardingColumn: user_id
          shardingAlgorithmName: user_mod
  shardingAlgorithms:
    user_mod:
      type: MOD
      props:
        sharding-count: 256
```

**账户表分表：**
- 按account_id % 256分表
- 与用户表类似

**交易表分表：**
- 按交易时间按月分表
- account_transaction_202401
- account_transaction_202402
- ...

#### 2.3.3 索引优化

**索引设计原则：**
1. 在高频查询字段上建立索引
2. 组合索引遵循最左前缀原则
3. 避免索引列使用函数
4. 控制索引数量（每表不超过5个）

**关键索引：**
```sql
-- 用户表
CREATE INDEX idx_phone_number ON user(phone_number);
CREATE INDEX idx_customer_id ON user(customer_id);
CREATE INDEX idx_status ON user(status);

-- 账户表
CREATE INDEX idx_customer_id ON account(customer_id);

-- 交易表
CREATE INDEX idx_account_id_time ON account_transaction(account_id, transaction_time DESC);
```

### 2.4 异步处理

#### 2.4.1 消息队列架构

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Producer   │────►│    Kafka     │────►│   Consumer   │
│  (微服务)     │     │   Cluster    │     │  (微服务)     │
└──────────────┘     └──────────────┘     └──────────────┘
                     ┌──────────────┐
                     │   ZooKeeper  │
                     │   Cluster    │
                     └──────────────┘
```

**Kafka集群：**
- 3个Broker节点
- 复制因子：3
- 分区数：根据并发量动态调整

**Topic设计：**
- `customer.events` - 客户相关事件
- `user.events` - 用户相关事件
- `account.events` - 账户相关事件
- `subscription.events` - 订购相关事件

**消费者组：**
- 每个微服务一个消费者组
- 支持水平扩展

#### 2.4.2 异步场景

**1. 事件通知：**
- 用户状态变更 → 通知计费中心
- 账户充值 → 检查欠费停机用户自动复机
- 套餐变更 → 通知计费中心更新计费规则

**2. 短信/邮件发送：**
- 欠费提醒短信
- 套餐变更通知短信
- 账户余额提醒

**3. 数据同步：**
- 客户信息变更 → 同步到各微服务缓存
- 用户状态变更 → 同步到报表系统

### 2.5 限流熔断

#### 2.5.1 限流策略

**令牌桶算法：**
```java
@RateLimiter(
    value = "api-limiter",
    rate = 1000,       // 每秒1000个令牌
    capacity = 2000    // 桶容量2000
)
public Response handleRequest() {
    // 业务逻辑
}
```

**限流维度：**
1. **IP限流**：单IP 100次/分钟
2. **用户限流**：单用户 1000次/分钟
3. **接口限流**：按接口特性设置
   - 查询接口：1000 TPS
   - 写操作接口：500 TPS

**限流实现：**
- 使用Redis + Lua脚本实现分布式限流
- 使用Sentinel进行流控

#### 2.5.2 熔断降级

**熔断策略：**
```java
@CircuitBreaker(
    name = "customer-service",
    fallbackMethod = "fallback",
    failureRateThreshold = 50,        // 失败率50%
    waitDurationInOpenState = 60s,    // 熔断60秒
    minimumNumberOfCalls = 10         // 最小调用次数10
)
public Customer getCustomer(Long customerId) {
    // 调用远程服务
}

public Customer fallback(Long customerId, Exception e) {
    // 降级逻辑：返回缓存数据或默认数据
    return cacheService.getCustomer(customerId);
}
```

**熔断状态：**
1. **CLOSED（关闭）**：正常调用
2. **OPEN（打开）**：拒绝调用，直接降级
3. **HALF_OPEN（半开）**：尝试恢复调用

#### 2.5.3 降级策略

**降级场景：**
1. **超时降级**：超过3秒未响应，返回默认值
2. **异常降级**：服务异常，返回缓存数据
3. **流量降级**：流量过大，关闭非核心功能

**降级开关：**
- 通过配置中心动态控制
- 支持实时开启/关闭降级

### 2.6 服务拆分与扩展

#### 2.6.1 服务实例配置

**平峰期配置：**
```
API Gateway:      4 instances
Customer Service: 2 instances
User Service:     8 instances  (高频服务)
Account Service:  4 instances
Subscription:     2 instances
```

**高峰期配置（自动扩展）：**
```
API Gateway:      8 instances  (+100%)
Customer Service: 4 instances  (+100%)
User Service:    16 instances  (+100%)
Account Service:  8 instances  (+100%)
Subscription:     4 instances  (+100%)
```

#### 2.6.2 自动扩展

**基于CPU的自动扩展：**
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: user-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service
  minReplicas: 8
  maxReplicas: 16
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

**扩展触发条件：**
- CPU使用率 > 70%
- 内存使用率 > 80%
- 请求队列长度 > 100

## 三、多渠道接入架构

### 3.1 渠道类型

1. **Web前台营业厅**：PC浏览器访问
2. **手机APP**：iOS/Android应用
3. **USSD**：短代码服务
4. **Call Center**：客服热线
5. **POS机**：营业厅终端

### 3.2 统一接入架构

```
┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐
│ Web  │  │ APP  │  │ USSD │  │ Call │  │ POS  │
└───┬──┘  └───┬──┘  └───┬──┘  └───┬──┘  └───┬──┘
    │         │         │         │         │
    └─────────┴─────────┴─────────┴─────────┘
              │
     ┌────────▼────────┐
     │  API Gateway    │
     │  - 协议适配      │
     │  - 认证授权      │
     │  - 限流熔断      │
     └────────┬────────┘
              │
     ┌────────▼────────┐
     │  微服务层        │
     └─────────────────┘
```

### 3.3 协议适配

**HTTP/HTTPS：**
- Web、APP、POS机使用
- RESTful API

**WebSocket：**
- 实时通知
- 在线客服

**USSD：**
- 短代码协议
- 协议转换网关

**SOAP/XML：**
- 遗留系统对接
- 协议转换

### 3.4 渠道权限控制

**渠道标识：**
```
X-Channel: WEB          # Web渠道
X-Channel: APP          # APP渠道
X-Channel: USSD         # USSD渠道
X-Channel: CALL_CENTER  # 呼叫中心
X-Channel: POS          # POS机
```

**权限矩阵：**
| 接口 | Web | APP | USSD | Call Center | POS |
|------|-----|-----|------|-------------|-----|
| 查询余额 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 充值 | ✓ | ✓ | ✗ | ✓ | ✓ |
| 开户 | ✗ | ✗ | ✗ | ✓ | ✓ |
| 销户 | ✗ | ✗ | ✗ | ✓ | ✓ |

## 四、监控与运维

### 4.1 监控体系

```
┌─────────────────────────────────────────────────────┐
│                  监控大盘                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │ 业务监控  │  │ 应用监控  │  │ 基础设施  │          │
│  │          │  │          │  │   监控    │          │
│  └──────────┘  └──────────┘  └──────────┘           │
└─────────────────────────────────────────────────────┘
          │              │              │
┌─────────▼──────┬───────▼──────┬───────▼─────────┐
│  Prometheus    │   Skywalking │    Grafana      │
│  (指标采集)     │   (链路追踪)  │    (可视化)     │
└────────────────┴──────────────┴─────────────────┘
```

### 4.2 关键指标

**业务指标：**
- 开户成功率
- 充值成功率
- 接口响应时间
- 业务办理量

**应用指标：**
- QPS/TPS
- 平均响应时间
- 错误率
- 服务可用性

**基础设施指标：**
- CPU使用率
- 内存使用率
- 磁盘IO
- 网络带宽

### 4.3 告警策略

**告警级别：**
1. **P0（紧急）**：服务不可用，立即处理
2. **P1（重要）**：服务降级，1小时内处理
3. **P2（一般）**：性能下降，24小时内处理
4. **P3（提示）**：潜在问题，定期检查

**告警规则：**
- CPU > 80% 持续5分钟 → P1告警
- 错误率 > 1% → P1告警
- 接口响应时间 > 3秒 → P2告警
- 服务不可用 → P0告警

### 4.4 日志管理

**日志收集：**
```
Application → Filebeat → Logstash → Elasticsearch → Kibana
```

**日志级别：**
- ERROR：错误日志
- WARN：警告日志
- INFO：信息日志
- DEBUG：调试日志

**日志格式：**
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "service": "user-service",
  "traceId": "550e8400-e29b-41d4-a716-446655440000",
  "spanId": "446655440000",
  "message": "User created successfully",
  "userId": 10001
}
```

## 五、总结

本架构设计具有以下特点：

1. **高性能**：多级缓存、读写分离、分库分表
2. **高可用**：服务多实例、熔断降级、限流保护
3. **高扩展**：微服务架构、水平扩展、自动扩缩容
4. **高安全**：认证授权、数据加密、操作审计
5. **易监控**：全链路追踪、实时监控、智能告警

能够支撑：
- 每日300W业务办理量
- 每日4亿次服务调用
- 高峰期14000+ TPS
- 99.9%系统可用性
